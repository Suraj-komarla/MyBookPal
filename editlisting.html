<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MyBookPal</title>
    <link rel="stylesheet" href="listAllBooks.css" />
    <link rel="stylesheet" href="sellingStyle.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <script src="listAllBooks.js"></script>
  </head>
  <body onload="loadBookDetails()">
    <header>
      <div class="brand">MyBookPal</div>
      <nav>
        <ul class="nav-menu">
          <li><a href="./listAllBooks.html" class="books-icon">Books</a></li>
          <!-- <li><a href="#ebooks" class="ebooks-icon"></a></li>
          <li><a href="#audiobooks" class="audiobooks-icon">Audiobooks</a></li>
          <li><a href="#bestsellers" class="bestsellers-icon">Bestsellers</a></li>
          <li><a href="#comingsoon" class="comingsoon-icon">Coming Soon</a></li> -->
          <li class="dropdown">
            <a href="#" class="bookLending-icon">BookLending</a>
            <div class="dropdown-content">
                <a href="#listAllLendingBooks.html" id="borrowBookOption">Borrow a book</a>
                <a href="#returnBook.html" id="returnBookOption">Return a book</a>
                <a href="#MyBorrowedBooks.html" id="myBorrowedBooksOption">My borrowed books</a>
            </div>
        </li>
        <li><a href="selling.html" class="books-icon">Selling Books</a></li>
        <li class="dropdown">
          <a href="#" class="bookLending-icon">Subscriptions</a>
          <div class="dropdown-content">
              <a href="#subscribeBook.html" id="borrowBookOption">Subscribe to a book</a>
              <a href="#unsubscribeBook.html" id="returnBookOption">Unsubscribe</a>
          </div>
        </li>
        <li><a href="#Wallet" class="Wallet_icon">Wallet</a></li>
        <li><a href="#cart" class="cart-icon"><i class="fa fa-opencart" style="padding:3px;"></i>Cart</a></li>
        <li><a href="./public/index.html">Contact Us</a></li>
        </ul>
      </nav>
        <ul class="user-menu">
          <!-- <li class="home-button"><a href="listAllBooks.html" class="home-icon">Home</a></li> -->
          
          <li class="dropdown">
            <a href="#account" class="account-icon"><i class="fa fa-user" style="padding:3px;"></i>My Account</a>
            <div class="dropdown-content">
                <a href="#listAllLendingBooks.html" id="borrowBookOption">Update Account</a>
                <a href="#listAllLendingBooks.html" id="borrowBookOption">Settings</a>
                <a href="./public/index.html" id="borrowBookOption">Contact Us</a>
                <a href="#listAllLendingBooks.html" id="borrowBookOption">Logout</a>
                <a href="#listAllLendingBooks.html" id="borrowBookOption">Sign In</a>
            </div>
          </li>
          
          
      </ul>
    </header>
    <div class="search-bar">
      <input type="text" placeholder="Search for books" />
      <button type="submit">Search</button>
      <div class="order-filter">
        <label for="orderBy">Sort By:</label>
        <select id="orderBy">
          <option value="lowToHigh">Low to High</option>
          <option value="highToLow">High to Low</option>
        </select>

        <label for="priceFilter">Price:</label>
        <select id="priceFilter">
          <option value="greaterThan50">Greater than 50</option>
          <option value="lessThan50">Less than 50</option>
          <option value="greaterThan10">Greater than 10</option>
          <option value="lessThan10">Less than 10</option>
        </select>
      </div>
    </div>
    <div class="main-container">
      <div class="create-container">
      <h2 style="margin-top: 50px;">Enter the details of your book</h2>

      <form onsubmit="submitListingForm(); return false;" id="bookListingForm">
        <table>
          <tr>
            <td><label for="title">Title:</label></td>
            <td><input type="text" id="title" name="title" required /></td>
          </tr>
          <tr>
            <td><label for="author">Author:</label></td>
            <td><input type="text" id="author" name="author" required /></td>
          </tr>
          <tr>
            <td><label for="condition">Book Condition:</label></td>
            <td>
              <select id="condition" name="condition" required>
                <option value="new">New</option>
                <option value="excellent">Excellent</option>
                <option value="likenew">Like New</option>
                <option value="good">Good</option>
                <option value="used">Used</option>
              </select>
            </td>
          </tr>
          <tr>
            <td><label for="price">Price:</label></td>
            <td>
              <input
                type="number"
                id="price"
                name="price"
                min="0"
                step="0.01"
                required
              />
            </td>
          </tr>
          <tr>
            <td><label for="genre">Book Genre:</label></td>
            <td>
              <select id="genre" name="genre" required>
                <option value="fiction">Fiction</option>
                <option value="fantasy">Fantasy</option>
                <option value="fantasyadv">Fantasy/Adventure</option>
                <option value="scifi">Science Fiction</option>
                <option value="romance">Romance</option>
                <option value="mystery">Mystery</option>
                <option value="romance">Romance</option>
                <option value="biography">Biography</option>
                <option value="kids">Kids</option>
                <option value="other">Other</option>
              </select>
            </td>
          </tr>
          <tr>
            <td><label for="description">Description:</label></td>
            <td>
              <textarea id="description" name="description" required></textarea>
            </td>
          </tr>
          <tr>
            <td><label for="quantity">Quantity:</label></td>
            <td>
              <input
                type="number"
                id="quantity"
                name="quantity"
                min="1"
                required
              />
            </td>
          </tr>
          <tr>
            <td><label for="photo">Upload Photo:</label></td>
            <td>
              <input type="file" id="photo" name="photo" accept="image/*" />
            </td>
          </tr>
          <tr></tr>
          <tr>
            <td>Do you want to make this listing an auction?</td>
            <td
              style="
                display: flex;
                flex-direction: row;
                justify-content: flex-start;
                align-items: center;
              "
            >
              <input
                type="radio"
                name="auctionOption"
                value="yes"
                onclick="showAuctionFields()"
              />
              Yes
              <input
                type="radio"
                name="auctionOption"
                value="no"
                onclick="hideAuctionFields()"
                checked
              />
              No
            </td>
          </tr>
        </table>

        <!-- Additional fields for auction -->
        <div id="auctionFields" style="display: none">
          <table style="width: 100%">
            <tr>
              <td><label for="startDate">Choose start date:</label></td>
              <td>
                <input type="datetime-local" id="startDate" name="startDate" />
              </td>
            </tr>
            <tr>
              <td><label for="endDate">Choose end date:</label></td>
              <td>
                <input type="datetime-local" id="endDate" name="endDate" />
              </td>
            </tr>
            <tr>
              <td><label for="reservePrice">Reserve Price:</label></td>
              <td>
                <input
                  type="number"
                  id="reservePrice"
                  name="reservePrice"
                  step="0.01"
                />
              </td>
            </tr>
            <tr>
              <td><label for="minIncrement">Minimum Increment:</label></td>
              <td>
                <input
                  type="number"
                  id="minIncrement"
                  name="minIncrement"
                  step="0.01"
                />
              </td>
            </tr>
          </table>
        </div>

        <div class="createlisting-btn">
          <button type="submit" class="create-btn">
            Update Listing
          </button>
        </div>
      </form>
    </div></div>
    
    <script>
        let bookId;
        async function loadBookDetails() {
        const urlParams = new URLSearchParams(window.location.search);
        bookId = urlParams.get("bookid");
        const sellerId = urlParams.get("sellerid");

        // Check if both bookId and sellerId are available
        if (bookId && sellerId) {
          try {
            const response = await fetch(
             // `http://127.0.0.1:3000/book?id=${bookId}&sellerid=${sellerId}`
              `http://127.0.0.1:8081/book?id=${bookId}`
            );
            
            if (!response.ok) {
              throw new Error(`HTTP error! Status: ${response.status}`);
            }

            const bookDetails = await response.json();
            console.log(bookDetails)
            populateFormFields(bookDetails);
          } catch (error) {
            console.error("Error fetching book details:", error.message);
            alert("Error fetching book details. Please try again.");
          }
        } else {
          console.error("BookId or sellerId is missing from the URL");
          alert("BookId or sellerId is missing from the URL");
        }
      }
      
      
      function populateFormFields(bookDetails) {
        // Populate the form fields with book details
        document.getElementById("title").value = bookDetails.Title;
        document.getElementById("author").value = bookDetails.Author;
        document.getElementById("condition").value = bookDetails.Book_condition.toLowerCase();
        document.getElementById("price").value = bookDetails.Price;
        document.getElementById("genre").value = bookDetails.Genre.toLowerCase();
        document.getElementById("description").value = bookDetails.Book_description;
        document.getElementById("quantity").value = bookDetails.Quantity;

        // Check if auction option is enabled
        if (bookDetails.Auction === 1) {
          //document.getElementById("auctionOptionYes").checked = true;

          // Populate auction fields
          document.querySelector('input[name="auctionOption"][value="yes"]').checked = true;
          document.querySelector('input[name="auctionOption"][value="no"]').checked = false;

        //   document.getElementById("auctionOptionYes").checked = true;
        //   document.getElementById("auctionOptionNo").checked = false;
          showAuctionFields()
          document.getElementById("startDate").value = new Date(bookDetails.StartDateTime).toISOString().slice(0, 16);
          document.getElementById("endDate").value = new Date(bookDetails.EndDateTime).toISOString().slice(0, 16);
          document.getElementById("reservePrice").value = bookDetails.ReservePrice;
          document.getElementById("minIncrement").value = bookDetails.MinimumIncrement;

          // Show auction fields
          showAuctionFields();
        } else {
          // Auction option is disabled, hide auction fields
        //   document.getElementById("auctionOptionNo").checked = true;
        //   document.getElementById("auctionOptionYes").checked = false;
        document.querySelector('input[name="auctionOption"][value="yes"]').checked = false;
          document.querySelector('input[name="auctionOption"][value="no"]').checked = true;
          hideAuctionFields();
        }
      }
      function showAuctionFields() {
        document.getElementById("auctionFields").style.display = "flex";
        document.getElementById("auctionFields").style.flexDirection = "column";
      }

      function hideAuctionFields() {
        document.getElementById("auctionFields").style.display = "none";
      }

      async function submitListingForm() {
        showAuctionFields();
        const formData = new FormData(
          document.getElementById("bookListingForm")
        );

        // Convert FormData to JSON
        const formDataJson = {};
        formData.forEach((value, key) => {
          formDataJson[key] = value;
        });

        const title = formDataJson["title"];
        const author = formDataJson["author"];
        const condition = formDataJson["condition"];
        const price = formDataJson["price"];
        const genre = formDataJson["genre"];
        const description = formDataJson["description"];
        const quantity = formDataJson["quantity"];
        let auction = 0;
        let bookData;
        if (formDataJson["auctionOption"] === "no") {
          auction = 0;
            bookData = {
                "title": title,
                "author": author,
                "book_condition": condition,
                "price": price,
                "genre": genre,
                "book_description": description,
                "quantity": quantity,
                "auction": auction,
            };
        }
        else if (formDataJson["auctionOption"] === "yes"){
            auction = 1;
            const startDate = new Date(formDataJson["startDate"]) ;
            const endDate = new Date(formDataJson["endDate"]) ;
            const resPrice = formDataJson["reservePrice"];
            const minInc = formDataJson["minIncrement"];
            const currDate = new Date();
           
            if(endDate < currDate){
              alert("End Date cannot be in the past");
              return;
            }
            if(startDate > endDate){
              alert("Your auction's start date cannot be later then end date");
              return;
            }
            bookData = {
                "title": title,
                "author": author,
                "book_condition": condition,
                "price": price,
                "genre": genre,
                "book_description": description,
                "quantity": quantity,
                "auction": auction,
                "startdatetime": startDate,
                "enddatetime": endDate,
                "reserveprice": resPrice,
                "minimumincrement": minInc,
            };
        }
        try {
            let id = 3;
            const response = await fetch(`http://127.0.0.1:3000/book/editlisting?sellerid=${id}&bookid=${bookId}`, 
            
            
            
            {
            method: "PUT", // Assuming you're making a POST request
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(bookData) ,
          });

          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          alert("Listing updated successfully!!")
          window.location.href = `selling.html`;
        } catch (error) {
          console.error("Error during form submission:", error);
        }
      }
    </script>
  </body>
</html>
