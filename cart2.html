<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MyBookPal</title>
    <link rel="stylesheet" href="cart.css" />
</head>

<body>
    <header>
        <div class="brand">MyBookPal</div>
        <nav>
            <ul class="nav-menu">
                <li><a href="#books" class="books-icon">Books</a></li>
                <li><a href="#ebooks" class="ebooks-icon">eBooks</a></li>
                <li><a href="#audiobooks" class="audiobooks-icon">Audiobooks</a></li>
                <li><a href="#bestsellers" class="bestsellers-icon">Bestsellers</a></li>
                <li><a href="#comingsoon" class="comingsoon-icon">Coming Soon</a></li>
                <li><a href="#giftcards" class="giftcards-icon">Gift Cards</a></li>
                <li><a href="#membership" class="membership_icon">Memberships</a></li>
            </ul>
        </nav>
        <ul class="user-menu">
            <li><a href="#account" class="account-icon">My Account</a></li>
            <li><a href="#wishlist" class="wishlist-icon">Wallet</a></li>
            <li><a href="#cart" class="cart-icon">Cart</a></li>
        </ul>
    </header>
    <div class="search-bar">
        <input type="text" id="searchInput" placeholder="Search for books">
        <button>Search</button>
        <div class="order-filter">
            <label for="orderBy">Sort By:</label>
            <select id="orderBy">
                <option value="lowToHigh">Low to High</option>
                <option value="highToLow">High to Low</option>
            </select>
        </div>
    </div>
    <div class="container">
        <table id="cart">
            <thead>
                <tr>
                    <th class="third">Product</th>
                    <th class="second">Quantity</th>
                    <th class="fourth">Total</th>
                    <th class="fifth">&nbsp;</th>
                </tr>
            </thead>
            <tbody id="cartDetails"></tbody>
            <tr class="totalprice">
                <td class="light">Total:</td>
                <td colspan="2">&nbsp;</td>
                <td colspan="2"><span class="thick">$225.45</span></td>
            </tr>
            <tr class="walletamount">
                <td class="light">Amount in Wallet:</td>
                <td colspan="2">&nbsp;</td>
                <td colspan="2"><span class="thick">$225.45</span></td>
            </tr>
            <tr class="checkoutrow">
                <td colspan="5" class="checkout-wallet-container">
                    <button id="submitbtn">Purchase Now!</button>
                    <button id="walletbtn">Go to Wallet</button>
                </td>
            </tr>
        </table>
    </div>
    <script>
        const serverURL = 'http://localhost:3000';
        const userId = 5;

        // Display cart details on page load
        document.addEventListener("DOMContentLoaded", function () {
            displayCartDetails(userId);
        });

        // Function to fetch cart details
        async function fetchCartDetails(userId) {
            try {
                const response = await fetch(`${serverURL}/view_cart?id=${userId}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Error fetching cart details:', error.message);
                throw error; // Propagate the error
            }
        }

        // Function to fetch book details
        async function fetchBookDetails(bookId) {
            try {
                const response = await fetch(`${serverURL}/get_book_details?id=${bookId}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Error fetching book details:', error.message);
                throw error; // Propagate the error
            }
        }

        // Function to display cart details on the page
        async function displayCartDetails(userId) {
            try {
                const cartDetails = await fetchCartDetails(userId);
                const tbody = document.getElementById('cartDetails');
                tbody.innerHTML = ''; // Clear the existing content before adding new items
                if (cartDetails.length > 0) {
                    let finalCartValue = 0;
                    for (const item of cartDetails) {
                        const bookDetails = await fetchBookDetails(item.BookID);
                        const totalPrice = item.Quantity * bookDetails[0].Price;
                        finalCartValue += totalPrice;
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${bookDetails[0].Title}</td>
                            <td>${item.Quantity}</td>
                            <td>${totalPrice.toFixed(2)}</td>
                            <td><span class="remove" onclick="removeItem(this)"><img
                                    src="https://i.imgur.com/h1ldGRr.png" alt="X"></span></td>
                        `;
                        tbody.appendChild(tr);
                    }
                    document.querySelector('.totalprice td span.thick').innerText = `$${finalCartValue.toFixed(2)}`;
                    // Fetch and update wallet amount separately
                    const walletResponse = await fetch(`${serverURL}/getWalletBalance?id=${userId}`);
                    const walletData = await walletResponse.json();
                    const walletAmount = walletData.balance;
                    document.querySelector('.walletamount td span.thick').innerText = `$${walletAmount.toFixed(2)}`;
                } else {
                    // No items in the cart
                    document.querySelector('.totalprice td span.thick').innerText = '$0.00';
                    document.querySelector('.walletamount td span.thick').innerText = '$0.00';
                    document.getElementById('cartDetails').innerHTML = 'No items in the cart.';
                }
            } catch (error) {
                console.error('Error fetching cart details:', error);
                // Handle error, e.g., display an error message to the user
            }
        }

        // Function to remove an item from the cart
        function removeItem(element) {
            // Implement the logic to remove the corresponding item from the cart
            const row = element.closest('tr');
            row.parentNode.removeChild(row);
        }
    </script>
</body>

</html>
